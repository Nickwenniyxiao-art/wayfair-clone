/**
 * Import Products to Digital Ocean MySQL Database
 * 
 * This script imports categories and products generated by generate-products.mjs
 * into the wayfair_clone database.
 */

import mysql from 'mysql2/promise';
import { productData } from './generate-products-with-s3.mjs';

// Database configuration
const DB_CONFIG = {
  host: '127.0.0.1',
  port: 3306,
  user: 'wayfair',
  password: 'Wayfair2024Secure',
  database: 'wayfair_clone'
};

async function importData() {
  let connection;
  
  try {
    console.log('ğŸ”Œ Connecting to Digital Ocean MySQL...');
    connection = await mysql.createConnection(DB_CONFIG);
    console.log('âœ… Connected successfully!\n');
    
    // Start transaction
    await connection.beginTransaction();
    
    // Clear existing data
    console.log('ğŸ—‘ï¸  Clearing existing data...');
    await connection.execute('DELETE FROM products WHERE id > 0');
    await connection.execute('DELETE FROM categories WHERE id > 0');
    console.log('âœ… Existing data cleared\n');
    
    // Import categories
    console.log('ğŸ“ Importing categories...');
    for (const category of productData.categories) {
      await connection.execute(
        `INSERT INTO categories (
          id, name, slug, description, icon, parentId, displayOrder, isActive, createdAt, updatedAt
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
        [
          category.id,
          category.name,
          category.slug,
          category.description,
          category.icon,
          category.parentId,
          category.displayOrder,
          category.isActive
        ]
      );
      console.log(`   âœ“ ${category.name} (${category.name_zh})`);
    }
    console.log(`âœ… Imported ${productData.categories.length} categories\n`);
    
    // Import products
    console.log('ğŸ›ï¸  Importing products...');
    let imported = 0;
    
    for (const product of productData.products) {
      await connection.execute(
        `INSERT INTO products (
          sku, name, slug, description, categoryId, price, originalPrice,
          stock, images, rating, reviewCount, isFeatured, isActive,
          createdAt, updatedAt
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
        [
          product.sku,
          product.name,
          product.slug,
          product.description,
          product.categoryId,
          product.price,
          product.compareAtPrice,
          product.stock,
          product.images,
          product.rating,
          product.reviewCount,
          product.isFeatured,
          product.isActive
        ]
      );
      
      imported++;
      if (imported % 20 === 0) {
        console.log(`   âœ“ Imported ${imported}/${productData.products.length} products...`);
      }
    }
    
    console.log(`âœ… Imported ${productData.products.length} products\n`);
    
    // Commit transaction
    await connection.commit();
    console.log('âœ… Transaction committed successfully!\n');
    
    // Display summary
    console.log('ğŸ“Š Import Summary:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`   Categories: ${productData.categories.length}`);
    console.log(`   Products: ${productData.products.length}`);
    console.log(`   - Furniture: ${productData.summary.furniture}`);
    console.log(`   - Decor: ${productData.summary.decor}`);
    console.log(`   - Lighting: ${productData.summary.lighting}`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    // Verify import
    const [categoryCount] = await connection.execute('SELECT COUNT(*) as count FROM categories');
    const [productCount] = await connection.execute('SELECT COUNT(*) as count FROM products');
    const [furnitureCount] = await connection.execute('SELECT COUNT(*) as count FROM products WHERE categoryId = 1');
    const [decorCount] = await connection.execute('SELECT COUNT(*) as count FROM products WHERE categoryId = 2');
    const [lightingCount] = await connection.execute('SELECT COUNT(*) as count FROM products WHERE categoryId = 3');
    
    console.log('âœ… Verification:');
    console.log(`   Categories in DB: ${categoryCount[0].count}`);
    console.log(`   Products in DB: ${productCount[0].count}`);
    console.log(`   - Furniture: ${furnitureCount[0].count}`);
    console.log(`   - Decor: ${decorCount[0].count}`);
    console.log(`   - Lighting: ${lightingCount[0].count}\n`);
    
    console.log('ğŸ‰ Import completed successfully!');
    
  } catch (error) {
    console.error('âŒ Error during import:', error);
    if (connection) {
      await connection.rollback();
      console.log('âš ï¸  Transaction rolled back');
    }
    process.exit(1);
  } finally {
    if (connection) {
      await connection.end();
      console.log('ğŸ”Œ Database connection closed');
    }
  }
}

// Run import
importData();
